{% extends "base.html" %}

{% block title %}Checkout - {{ brand_name }}{% endblock %}

{% block styles %}
<style>
    .checkout-header {
        background: linear-gradient(rgba(26, 26, 26, 0.9), rgba(26, 26, 26, 0.95)), 
                    url('https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
        background-size: cover;
        background-position: center;
        color: white;
        padding: 80px 0 40px;
        margin-top: 76px;
    }
    
    .checkout-container {
        padding: 40px 0;
    }
    
    .checkout-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 50px;
        position: relative;
        counter-reset: step;
    }
    
    .checkout-steps::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--light-gray);
        z-index: 1;
    }
    
    .checkout-step {
        position: relative;
        z-index: 2;
        text-align: center;
        flex: 1;
    }
    
    .step-number {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        background: white;
        color: var(--gray-color);
        border: 3px solid var(--light-gray);
        border-radius: 50%;
        font-weight: 600;
        font-size: 1.2rem;
        position: relative;
    }
    
    .checkout-step.active .step-number {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .checkout-step.completed .step-number {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }
    
    .step-label {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--gray-color);
    }
    
    .checkout-step.active .step-label {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .checkout-step.completed .step-label {
        color: var(--success-color);
    }
    
    .checkout-form-section {
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        padding: 40px;
        margin-bottom: 30px;
    }
    
    .section-title {
        font-size: 1.4rem;
        color: var(--secondary-color);
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light-gray);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    
    .shipping-methods {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
    }
    
    .shipping-method {
        display: flex;
        align-items: center;
        padding: 20px;
        border: 2px solid var(--light-gray);
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .shipping-method:hover {
        border-color: var(--primary-color);
    }
    
    .shipping-method.selected {
        border-color: var(--primary-color);
        background: rgba(138, 109, 59, 0.05);
    }
    
    .method-radio {
        margin-right: 15px;
    }
    
    .method-details {
        flex: 1;
    }
    
    .method-price {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .payment-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .payment-method {
        text-align: center;
        padding: 25px 20px;
        border: 2px solid var(--light-gray);
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .payment-method:hover {
        border-color: var(--primary-color);
        transform: translateY(-5px);
    }
    
    .payment-method.selected {
        border-color: var(--primary-color);
        background: rgba(138, 109, 59, 0.05);
    }
    
    .payment-icon {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 15px;
    }
    
    .order-summary {
        position: sticky;
        top: 100px;
        background: white;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-md);
        padding: 30px;
    }
    
    .order-items {
        max-height: 300px;
        overflow-y: auto;
        margin: 20px 0;
        padding-right: 10px;
    }
    
    .order-item {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--light-gray);
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .order-item-image {
        width: 60px;
        height: 60px;
        border-radius: var(--border-radius-sm);
        overflow: hidden;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .order-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .order-item-details {
        flex: 1;
    }
    
    .order-item-name {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .order-item-price {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .summary-totals {
        margin: 25px 0;
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--light-gray);
    }
    
    .summary-row.total {
        border-bottom: none;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary-color);
        padding-top: 20px;
        margin-top: 10px;
        border-top: 2px solid var(--light-gray);
    }
    
    .terms-agreement {
        margin: 25px 0;
    }
    
    .checkout-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }
    
    .checkout-actions .btn {
        flex: 1;
    }
    
    @media (max-width: 992px) {
        .checkout-steps {
            flex-direction: column;
            gap: 30px;
        }
        
        .checkout-steps::before {
            display: none;
        }
        
        .checkout-step {
            display: flex;
            align-items: center;
            text-align: left;
            gap: 20px;
        }
        
        .step-number {
            margin: 0;
        }
        
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .payment-methods {
            grid-template-columns: 1fr;
        }
        
        .order-summary {
            position: static;
            margin-top: 30px;
        }
    }
    
    @media (max-width: 576px) {
        .checkout-form-section {
            padding: 25px 20px;
        }
        
        .checkout-actions {
            flex-direction: column;
        }
        
        .shipping-method {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
        
        .method-radio {
            margin-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Checkout Header -->
<section class="checkout-header">
    <div class="container">
        <h1 class="text-center mb-3">Checkout</h1>
        <p class="text-center text-light mb-0">Complete your order in a few simple steps</p>
        
        <nav aria-label="breadcrumb" class="mt-4">
            <ol class="breadcrumb justify-content-center">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/cart">Cart</a></li>
                <li class="breadcrumb-item active">Checkout</li>
            </ol>
        </nav>
    </div>
</section>

<!-- Checkout Steps -->
<section class="checkout-container">
    <div class="container">
        <div class="checkout-steps">
            <div class="checkout-step active">
                <div class="step-number">1</div>
                <div class="step-label">Shipping Details</div>
            </div>
            <div class="checkout-step">
                <div class="step-number">2</div>
                <div class="step-label">Payment Method</div>
            </div>
            <div class="checkout-step">
                <div class="step-number">3</div>
                <div class="step-label">Confirmation</div>
            </div>
        </div>
        
        <div class="row">
            <!-- Checkout Form -->
            <div class="col-lg-8">
                <!-- Shipping Details -->
                <div class="checkout-form-section" id="shippingSection">
                    <h3 class="section-title">
                        <i class="fas fa-truck me-2"></i> Shipping Details
                    </h3>
                    
                    <form id="shippingForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-control" 
                                       value="{{ session.user_name.split(' ')[0] if session.user_name else '' }}"
                                       required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-control" 
                                       value="{{ session.user_name.split(' ')[1] if session.user_name and session.user_name.split(' ')|length > 1 else '' }}"
                                       required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email Address *</label>
                                <input type="email" class="form-control" 
                                       value="{{ session.user_email if session.user_email else '' }}"
                                       required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" 
                                       value="{{ session.user_phone if session.user_phone else '' }}"
                                       required>
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">Address *</label>
                            <input type="text" class="form-control" placeholder="Street address" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">City *</label>
                                <input type="text" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">State *</label>
                                <select class="form-select" required>
                                    <option value="">Select State</option>
                                    <option value="Lagos">Lagos</option>
                                    <option value="Abuja">Abuja</option>
                                    <option value="Rivers">Rivers</option>
                                    <option value="Kano">Kano</option>
                                    <option value="Oyo">Oyo</option>
                                    <option value="Edo">Edo</option>
                                    <option value="Delta">Delta</option>
                                    <option value="Kaduna">Kaduna</option>
                                    <option value="Ogun">Ogun</option>
                                    <option value="Enugu">Enugu</option>
                                    <option value="Anambra">Anambra</option>
                                    <option value="Akwa Ibom">Akwa Ibom</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">Delivery Instructions (Optional)</label>
                            <textarea class="form-control" rows="3" 
                                      placeholder="Any special delivery instructions..."></textarea>
                        </div>
                    </form>
                </div>
                
                <!-- Shipping Method -->
                <div class="checkout-form-section" id="shippingMethodSection">
                    <h3 class="section-title">
                        <i class="fas fa-shipping-fast me-2"></i> Shipping Method
                    </h3>
                    
                    <div class="shipping-methods">
                        <div class="shipping-method selected" onclick="selectShippingMethod(this, 'standard')">
                            <div class="method-radio">
                                <input type="radio" name="shippingMethod" value="standard" checked>
                            </div>
                            <div class="method-details">
                                <div class="method-name">
                                    <strong>Standard Delivery</strong>
                                    <span class="badge bg-success ms-2">Free</span>
                                </div>
                                <div class="method-description">
                                    Delivery within 3-5 business days
                                </div>
                            </div>
                            <div class="method-price">₦0.00</div>
                        </div>
                        
                        <div class="shipping-method" onclick="selectShippingMethod(this, 'express')">
                            <div class="method-radio">
                                <input type="radio" name="shippingMethod" value="express">
                            </div>
                            <div class="method-details">
                                <div class="method-name">
                                    <strong>Express Delivery</strong>
                                </div>
                                <div class="method-description">
                                    Delivery within 1-2 business days
                                </div>
                            </div>
                            <div class="method-price">₦5,000</div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method -->
                <div class="checkout-form-section" id="paymentSection" style="display: none;">
                    <h3 class="section-title">
                        <i class="fas fa-credit-card me-2"></i> Payment Method
                    </h3>
                    
                    <div class="payment-methods">
                        <div class="payment-method selected" onclick="selectPaymentMethod(this, 'bank')">
                            <div class="payment-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <h5>Bank Transfer</h5>
                            <p class="text-muted small">Pay via bank transfer to our account</p>
                        </div>
                        
                        <div class="payment-method" onclick="selectPaymentMethod(this, 'whatsapp')">
                            <div class="payment-icon">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <h5>WhatsApp Payment</h5>
                            <p class="text-muted small">Pay via WhatsApp with our agent</p>
                        </div>
                    </div>
                    
                    <!-- Bank Transfer Details -->
                    <div class="bank-details mt-4" id="bankDetails">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i> Payment Instructions</h5>
                            <p class="mb-2">Please transfer the exact amount to:</p>
                            <div class="mb-2">
                                <strong>Bank:</strong> {{ payment_config.bank_name }}
                            </div>
                            <div class="mb-2">
                                <strong>Account Number:</strong> {{ payment_config.account_number }}
                            </div>
                            <div class="mb-2">
                                <strong>Account Name:</strong> {{ payment_config.account_name }}
                            </div>
                            <div class="mt-3">
                                <strong>Important:</strong> Use your order number as the payment reference
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Buttons -->
                <div class="checkout-actions">
                    <a href="/cart" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Cart
                    </a>
                    <button class="btn btn-primary" id="nextStepBtn" onclick="nextStep()">
                        Continue to Payment <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                    <button class="btn btn-success" id="placeOrderBtn" 
                            style="display: none;" onclick="placeOrder()">
                        <i class="fas fa-lock me-2"></i> Place Order
                    </button>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h3 class="section-title">Order Summary</h3>
                    
                    <div class="order-items">
                        <!-- Items would be dynamically loaded from cart -->
                        <div class="order-item">
                            <div class="order-item-image">
                                <img src="https://images.unsplash.com/photo-1596703923338-48f1c07e4f2e?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80" 
                                     alt="Product">
                            </div>
                            <div class="order-item-details">
                                <div class="order-item-name">Premium Hair 24"</div>
                                <div class="order-item-quantity">Qty: 1</div>
                            </div>
                            <div class="order-item-price">₦134,985</div>
                        </div>
                    </div>
                    
                    <div class="summary-totals">
                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>{{ formatted_subtotal }}</span>
                        </div>
                        
                        <div class="summary-row">
                            <span>Shipping</span>
                            <span>{{ formatted_shipping }}</span>
                        </div>
                        
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>{{ formatted_total }}</span>
                        </div>
                    </div>
                    
                    <!-- Terms Agreement -->
                    <div class="terms-agreement">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="termsAgreement" required>
                            <label class="form-check-label small" for="termsAgreement">
                                I agree to the <a href="/terms">Terms & Conditions</a> and 
                                <a href="/privacy">Privacy Policy</a>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Security Badge -->
                    <div class="text-center mt-4">
                        <div class="d-flex align-items-center justify-content-center gap-2">
                            <i class="fas fa-shield-alt text-success fs-4"></i>
                            <div class="text-start">
                                <div class="small fw-bold">Secure Checkout</div>
                                <div class="small text-muted">Your information is protected</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    let currentStep = 1;
    
    // Shipping Method Selection
    function selectShippingMethod(element, method) {
        document.querySelectorAll('.shipping-method').forEach(el => {
            el.classList.remove('selected');
            el.querySelector('input[type="radio"]').checked = false;
        });
        
        element.classList.add('selected');
        element.querySelector('input[type="radio"]').checked = true;
        
        // Update shipping cost
        updateShippingCost(method);
    }
    
    // Payment Method Selection
    function selectPaymentMethod(element, method) {
        document.querySelectorAll('.payment-method').forEach(el => {
            el.classList.remove('selected');
        });
        
        element.classList.add('selected');
        
        // Show relevant payment details
        if (method === 'bank') {
            document.getElementById('bankDetails').style.display = 'block';
        } else {
            document.getElementById('bankDetails').style.display = 'none';
        }
    }
    
    // Update Shipping Cost
    function updateShippingCost(method) {
        // This would typically update the order summary via API
        // For now, we'll just update the UI
        const shippingElement = document.querySelector('.summary-row:nth-child(2) span:last-child');
        if (method === 'express') {
            shippingElement.textContent = '₦5,000.00';
            // Update total (this would need actual calculation)
        } else {
            shippingElement.textContent = '₦0.00';
        }
    }
    
    // Next Step
    function nextStep() {
        // Validate current step
        if (currentStep === 1) {
            if (!validateShippingForm()) {
                showToast('Error', 'Please fill in all required shipping details', 'error');
                return;
            }
            
            // Move to payment step
            document.getElementById('shippingSection').style.display = 'none';
            document.getElementById('shippingMethodSection').style.display = 'none';
            document.getElementById('paymentSection').style.display = 'block';
            
            // Update steps UI
            document.querySelectorAll('.checkout-step')[0].classList.remove('active');
            document.querySelectorAll('.checkout-step')[0].classList.add('completed');
            document.querySelectorAll('.checkout-step')[1].classList.add('active');
            
            // Update button
            document.getElementById('nextStepBtn').style.display = 'none';
            document.getElementById('placeOrderBtn').style.display = 'block';
            
            currentStep = 2;
            
        } else if (currentStep === 2) {
            // Already on payment step
        }
    }
    
    // Validate Shipping Form
    function validateShippingForm() {
        const form = document.getElementById('shippingForm');
        const requiredFields = form.querySelectorAll('[required]');
        
        for (let field of requiredFields) {
            if (!field.value.trim()) {
                field.focus();
                return false;
            }
        }
        
        return true;
    }
    
    // Place Order
    async function placeOrder() {
        // Validate payment method
        const paymentMethod = document.querySelector('.payment-method.selected h5').textContent;
        if (!paymentMethod) {
            showToast('Error', 'Please select a payment method', 'error');
            return;
        }
        
        // Validate terms agreement
        if (!document.getElementById('termsAgreement').checked) {
            showToast('Error', 'Please agree to the terms and conditions', 'error');
            return;
        }
        
        const button = document.getElementById('placeOrderBtn');
        const originalText = button.innerHTML;
        
        // Show loading
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
        button.disabled = true;
        
        try {
            // Collect order data
            const orderData = {
                name: document.querySelector('input[type="text"]').value,
                email: document.querySelector('input[type="email"]').value,
                phone: document.querySelector('input[type="tel"]').value,
                address: document.querySelectorAll('input[type="text"]')[3].value,
                city: document.querySelectorAll('input[type="text"]')[4].value,
                state: document.querySelector('select').value,
                notes: document.querySelector('textarea').value,
                payment_method: paymentMethod.toLowerCase().includes('bank') ? 'bank_transfer' : 'whatsapp'
            };
            
            // Submit order
            const response = await fetch('/place-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update steps UI
                document.querySelectorAll('.checkout-step')[1].classList.remove('active');
                document.querySelectorAll('.checkout-step')[1].classList.add('completed');
                document.querySelectorAll('.checkout-step')[2].classList.add('active');
                
                // Redirect to payment page
                window.location.href = `/payment/${result.order_id}`;
                
            } else {
                showToast('Error', result.message || 'Failed to place order', 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
            
        } catch (error) {
            showToast('Error', 'Failed to place order. Please try again.', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Set default shipping method
        selectShippingMethod(document.querySelector('.shipping-method'), 'standard');
        
        // Set default payment method
        selectPaymentMethod(document.querySelector('.payment-method'), 'bank');
    });
</script>
{% endblock %}
