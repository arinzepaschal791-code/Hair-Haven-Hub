# ========== CATEGORY MANAGEMENT ROUTES ==========

@app.route('/admin/categories/add', methods=['POST'])
@admin_required
def admin_add_category():
    """Add new category"""
    try:
        name = request.form.get('name')
        description = request.form.get('description')
        slug = request.form.get('slug')
        image = request.files.get('image')
        
        if not name:
            flash('Category name is required', 'danger')
            return redirect(url_for('admin_categories'))
        
        # Generate slug if not provided
        if not slug:
            slug = generate_unique_slug(name, Category)
        else:
            # Ensure slug is unique
            slug = generate_unique_slug(slug, Category)
        
        # Handle image upload
        image_url = None
        if image and image.filename:
            image_url = save_uploaded_file(image)
        
        category = Category(
            name=name,
            slug=slug,
            description=description,
            image_url=image_url
        )
        
        db.session.add(category)
        db.session.commit()
        
        flash(f'Category "{name}" added successfully!', 'success')
        return redirect(url_for('admin_categories'))
        
    except Exception as e:
        db.session.rollback()
        print(f"❌ Add category error: {str(e)}", file=sys.stderr)
        flash('Error adding category. Please try again.', 'danger')
        return redirect(url_for('admin_categories'))

@app.route('/admin/categories/edit/<int:id>', methods=['POST'])
@admin_required
def admin_edit_category(id):
    """Edit category"""
    try:
        category = Category.query.get_or_404(id)
        
        name = request.form.get('name')
        description = request.form.get('description')
        slug = request.form.get('slug')
        image = request.files.get('image')
        
        if not name:
            flash('Category name is required', 'danger')
            return redirect(url_for('admin_categories'))
        
        category.name = name
        category.description = description
        
        # Update slug if provided
        if slug and slug != category.slug:
            category.slug = generate_unique_slug(slug, Category, category.id)
        
        # Handle image upload
        if image and image.filename:
            image_url = save_uploaded_file(image)
            if image_url:
                category.image_url = image_url
        
        db.session.commit()
        
        flash(f'Category "{name}" updated successfully!', 'success')
        return redirect(url_for('admin_categories'))
        
    except Exception as e:
        db.session.rollback()
        print(f"❌ Edit category error: {str(e)}", file=sys.stderr)
        flash('Error updating category. Please try again.', 'danger')
        return redirect(url_for('admin_categories'))

@app.route('/admin/categories/delete/<int:id>', methods=['POST'])
@admin_required
def admin_delete_category(id):
    """Delete category"""
    try:
        category = Category.query.get_or_404(id)
        category_name = category.name
        
        # Check if category has products
        if category.products:
            flash(f'Cannot delete category "{category_name}" because it contains products. Remove or reassign products first.', 'danger')
            return redirect(url_for('admin_categories'))
        
        db.session.delete(category)
        db.session.commit()
        
        flash(f'Category "{category_name}" deleted successfully!', 'success')
        return redirect(url_for('admin_categories'))
        
    except Exception as e:
        db.session.rollback()
        print(f"❌ Delete category error: {str(e)}", file=sys.stderr)
        flash('Error deleting category. Please try again.', 'danger')
        return redirect(url_for('admin_categories'))

# ========== SETTINGS ROUTES ==========

@app.route('/admin/settings/update', methods=['POST'])
@admin_required
def admin_update_settings():
    """Update settings (demo version)"""
    try:
        # In a real application, you would save settings to a database
        # For now, we'll just show a success message
        setting_type = request.form.get('type')
        
        flash(f'{setting_type.capitalize()} settings updated successfully!', 'success')
        return redirect(url_for('admin_settings'))
        
    except Exception as e:
        print(f"❌ Update settings error: {str(e)}", file=sys.stderr)
        flash('Error updating settings. Please try again.', 'danger')
        return redirect(url_for('admin_settings'))

@app.route('/admin/reset-db', methods=['POST'])
@admin_required
def admin_reset_db():
    """Reset database to initial state (demo)"""
    try:
        # This is a demo endpoint - in production, implement proper backup/restore
        return jsonify({
            'success': True,
            'message': 'Database reset functionality would be implemented in production'
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
