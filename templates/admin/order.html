{% extends "admin/base.html" %}

{% block title %}Orders - {{ config.brand_name }} Admin{% endblock %}

{% block page_title %}Order Management{% endblock %}
{% block page_subtitle %}Manage and track all customer orders{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card-admin bg-stat-1 text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Orders</h6>
                            <h2 class="text-white mb-0">{{ total_orders|default(0) }}</h2>
                            <small class="text-white-50">All time orders</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card-admin bg-stat-2 text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Pending</h6>
                            <h2 class="text-white mb-0">{{ pending_orders|default(0) }}</h2>
                            <small class="text-white-50">Require attention</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card-admin bg-stat-3 text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Processing</h6>
                            <h2 class="text-white mb-0">{{ processing_orders|default(0) }}</h2>
                            <small class="text-white-50">Being prepared</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card-admin bg-stat-4 text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Shipped</h6>
                            <h2 class="text-white mb-0">{{ shipped_orders|default(0) }}</h2>
                            <small class="text-white-50">In transit</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card-admin bg-stat-5 text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Delivered</h6>
                            <h2 class="text-white mb-0">{{ delivered_orders|default(0) }}</h2>
                            <small class="text-white-50">Completed orders</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card-admin bg-stat-6 text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Cancelled</h6>
                            <h2 class="text-white mb-0">{{ cancelled_orders|default(0) }}</h2>
                            <small class="text-white-50">Cancelled orders</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-times-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card-admin mb-4">
        <div class="card-header-admin d-flex justify-content-between align-items-center">
            <h5>Filters & Search</h5>
            <div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="printOrders()">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('admin_orders') }}" class="row g-3">
                <div class="col-md-3">
                    <label for="status" class="form-label-admin">Order Status</label>
                    <select name="status" id="status" class="form-control-admin">
                        <option value="all" {% if status == 'all' %}selected{% endif %}>All Statuses</option>
                        <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="processing" {% if status == 'processing' %}selected{% endif %}>Processing</option>
                        <option value="shipped" {% if status == 'shipped' %}selected{% endif %}>Shipped</option>
                        <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>Delivered</option>
                        <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="payment_status" class="form-label-admin">Payment Status</label>
                    <select name="payment_status" id="payment_status" class="form-control-admin">
                        <option value="all" {% if not payment_status %}selected{% endif %}>All Payments</option>
                        <option value="pending" {% if payment_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="paid" {% if payment_status == 'paid' %}selected{% endif %}>Paid</option>
                        <option value="failed" {% if payment_status == 'failed' %}selected{% endif %}>Failed</option>
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="date_from" class="form-label-admin">From Date</label>
                    <input type="date" class="form-control-admin" id="date_from" name="date_from" 
                           value="{{ date_from if date_from else '' }}">
                </div>
                
                <div class="col-md-2">
                    <label for="date_to" class="form-label-admin">To Date</label>
                    <input type="date" class="form-control-admin" id="date_to" name="date_to" 
                           value="{{ date_to if date_to else '' }}">
                </div>
                
                <div class="col-md-2">
                    <label for="search" class="form-label-admin">Search</label>
                    <input type="text" class="form-control-admin" id="search" name="search" 
                           value="{{ search if search else '' }}" placeholder="Order #, Customer...">
                </div>
                
                <div class="col-12 mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="submit" class="btn btn-primary-admin">
                                <i class="fas fa-filter me-1"></i> Apply Filters
                            </button>
                            <a href="{{ url_for('admin_orders') }}" class="btn btn-secondary">
                                <i class="fas fa-redo me-1"></i> Reset
                            </a>
                        </div>
                        
                        <div class="text-muted">
                            {% if orders %}
                            <small>Showing {{ orders|length }} order{% if orders|length != 1 %}s{% endif %}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card-admin">
        <div class="card-header-admin d-flex justify-content-between align-items-center">
            <h5>All Orders</h5>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshOrders()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="dropdown d-inline-block">
                    <button class="btn btn-sm btn-primary-admin dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-plus me-1"></i> New Order
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="createNewOrder()">
                            <i class="fas fa-shopping-cart me-2"></i> Create Order
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('shop') }}" target="_blank">
                            <i class="fas fa-external-link-alt me-2"></i> View Store
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-admin" id="ordersTable">
                <thead>
                    <tr>
                        <th width="50">
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th width="120">Order #</th>
                        <th>Customer</th>
                        <th width="100">Items</th>
                        <th width="120">Amount</th>
                        <th width="100">Status</th>
                        <th width="100">Payment</th>
                        <th width="120">Date</th>
                        <th width="100" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if orders and orders|length > 0 %}
                        {% for order in orders %}
                        <tr data-order-id="{{ order.id }}">
                            <td>
                                <input type="checkbox" class="order-checkbox form-check-input" value="{{ order.id }}">
                            </td>
                            <td>
                                <div class="fw-medium text-primary">{{ order.order_number }}</div>
                                {% if not order.customer_id %}
                                <small class="text-muted d-block">Guest</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-2" 
                                         style="width: 32px; height: 32px; background: #{{ '%06x' % (order.id * 123456) % 0xffffff }}; 
                                                color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                        {{ order.customer_name[0]|upper if order.customer_name else 'G' }}
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ order.customer_name }}</div>
                                        <small class="text-muted d-block">{{ order.customer_email }}</small>
                                        {% if order.customer_phone %}
                                        <small class="text-muted">{{ order.customer_phone }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge-admin bg-light text-dark">
                                    {{ order.items|length if order.items else 0 }}
                                </span>
                            </td>
                            <td>
                                <div class="fw-medium">{{ format_price(order.final_amount) }}</div>
                                <small class="text-muted d-block">Shipping: {{ format_price(order.shipping_amount) }}</small>
                            </td>
                            <td>
                                {% set status_badge_class = {
                                    'pending': 'warning',
                                    'processing': 'info',
                                    'shipped': 'primary',
                                    'delivered': 'success',
                                    'cancelled': 'danger'
                                } %}
                                <span class="badge-admin badge-{{ status_badge_class.get(order.status, 'secondary') }}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>
                                {% set payment_badge_class = {
                                    'pending': 'warning',
                                    'paid': 'success',
                                    'failed': 'danger'
                                } %}
                                <span class="badge-admin badge-{{ payment_badge_class.get(order.payment_status, 'secondary') }}">
                                    {{ order.payment_status|title }}
                                </span>
                                {% if order.payment_method %}
                                <small class="d-block text-muted">{{ order.payment_method|title }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ order.created_at.strftime('%b %d') }}</div>
                                <small class="text-muted">{{ order.created_at.strftime('%I:%M %p') }}</small>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('admin_order_detail', id=order.id) }}" 
                                       class="btn btn-outline-primary"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    
                                    <button type="button" 
                                            class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" 
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                        <span class="visually-hidden">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="{{ url_for('admin_order_detail', id=order.id) }}">
                                                <i class="fas fa-eye me-2"></i> View Details
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="updateOrderStatus({{ order.id }})">
                                                <i class="fas fa-edit me-2"></i> Update Status
                                            </a>
                                        </li>
                                        {% if order.payment_status == 'pending' %}
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="markAsPaid({{ order.id }})">
                                                <i class="fas fa-money-bill me-2"></i> Mark as Paid
                                            </a>
                                        </li>
                                        {% endif %}
                                        <li><hr class="dropdown-divider"></li>
                                        {% if order.status != 'cancelled' %}
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="cancelOrder({{ order.id }})">
                                                <i class="fas fa-times me-2"></i> Cancel Order
                                            </a>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-shopping-bag fa-3x text-muted mb-3 d-block"></i>
                                    <h5>No Orders Found</h5>
                                    <p class="text-muted mb-0">No orders match your current filters.</p>
                                    {% if status != 'all' or search or date_from or date_to %}
                                    <a href="{{ url_for('admin_orders') }}" class="btn btn-primary-admin mt-3">
                                        <i class="fas fa-redo me-2"></i> Reset Filters
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="card-admin mt-3" id="bulkActions" style="display: none;">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span id="selectedCount">0</span> order(s) selected
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" id="bulkActionSelect">
                        <option value="">Bulk Actions</option>
                        <option value="status">Update Status</option>
                        <option value="payment">Update Payment</option>
                        <option value="export">Export Selected</option>
                        <option value="print">Print Selected</option>
                        <option value="cancel">Cancel Orders</option>
                    </select>
                    <button class="btn btn-sm btn-primary-admin" onclick="applyBulkAction()">Apply</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="orderId" name="order_id">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label-admin">Select Status</label>
                        <select class="form-control-admin" id="newStatus" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label-admin">Notes (Optional)</label>
                        <textarea class="form-control-admin" id="statusNotes" name="notes" rows="3" 
                                  placeholder="Add any notes about the status update..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="trackingNumber" class="form-label-admin">Tracking Number</label>
                        <input type="text" class="form-control-admin" id="trackingNumber" name="tracking_number" 
                               placeholder="Enter tracking number (for shipped orders)">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-admin" onclick="submitStatusUpdate()">
                    <i class="fas fa-save me-1"></i> Update Status
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-stat-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .bg-stat-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .bg-stat-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .bg-stat-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .bg-stat-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .bg-stat-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }
    
    .empty-state i {
        opacity: 0.5;
    }
    
    .avatar {
        flex-shrink: 0;
    }
    
    #bulkActions {
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Variables
    let currentOrderId = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        initEventListeners();
        initTooltips();
        
        // Set default dates if not set
        const today = new Date().toISOString().split('T')[0];
        if (!document.getElementById('date_from').value) {
            // Set to 30 days ago
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            document.getElementById('date_from').value = thirtyDaysAgo.toISOString().split('T')[0];
        }
        if (!document.getElementById('date_to').value) {
            document.getElementById('date_to').value = today;
        }
    });
    
    function initEventListeners() {
        // Select All checkbox
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActions();
        });
        
        // Individual checkboxes
        document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });
        
        // Bulk action select
        document.getElementById('bulkActionSelect').addEventListener('change', function() {
            if (this.value === 'status') {
                showBulkStatusModal();
            }
        });
    }
    
    function initTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }
    
    // Bulk Actions
    function updateBulkActions() {
        const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
        const bulkActionsDiv = document.getElementById('bulkActions');
        
        if (selectedCount > 0) {
            document.getElementById('selectedCount').textContent = selectedCount;
            bulkActionsDiv.style.display = 'block';
        } else {
            bulkActionsDiv.style.display = 'none';
        }
    }
    
    function clearSelection() {
        document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        document.getElementById('selectAll').checked = false;
        updateBulkActions();
    }
    
    function applyBulkAction() {
        const action = document.getElementById('bulkActionSelect').value;
        const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (!action) {
            showToast('Please select an action', 'warning');
            return;
        }
        
        if (selectedIds.length === 0) {
            showToast('No orders selected', 'warning');
            return;
        }
        
        switch(action) {
            case 'status':
                showBulkStatusModal(selectedIds);
                break;
            case 'payment':
                updateBulkPayment(selectedIds);
                break;
            case 'export':
                exportSelectedOrders(selectedIds);
                break;
            case 'print':
                printSelectedOrders(selectedIds);
                break;
            case 'cancel':
                cancelSelectedOrders(selectedIds);
                break;
        }
    }
    
    // Order Status Functions
    function updateOrderStatus(orderId) {
        currentOrderId = orderId;
        document.getElementById('orderId').value = orderId;
        
        // Get current status
        const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
        const currentStatus = row.querySelector('.badge-admin').textContent.toLowerCase().trim();
        document.getElementById('newStatus').value = currentStatus;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
        modal.show();
    }
    
    function submitStatusUpdate() {
        const orderId = document.getElementById('orderId').value;
        const status = document.getElementById('newStatus').value;
        const notes = document.getElementById('statusNotes').value;
        const trackingNumber = document.getElementById('trackingNumber').value;
        
        if (!status) {
            showToast('Please select a status', 'warning');
            return;
        }
        
        showLoading();
        
        fetch(`/admin/orders/update-status/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCSRFToken()
            },
            body: new URLSearchParams({
                'status': status,
                'notes': notes,
                'tracking_number': trackingNumber,
                'csrf_token': getCSRFToken()
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Network response was not ok');
        })
        .then(data => {
            hideLoading();
            
            if (data.success) {
                // Update UI
                const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                const statusBadge = row.querySelector('.badge-admin');
                
                // Update badge
                const statusClasses = {
                    'pending': 'warning',
                    'processing': 'info',
                    'shipped': 'primary',
                    'delivered': 'success',
                    'cancelled': 'danger'
                };
                
                // Remove existing status classes
                statusBadge.className = statusBadge.className.replace(/badge-\w+/, '');
                // Add new class
                statusBadge.classList.add(`badge-${statusClasses[status]}`);
                statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('updateStatusModal')).hide();
                
                // Reset form
                document.getElementById('statusForm').reset();
                
                showToast('Order status updated successfully!', 'success');
                
                // Refresh stats if needed
                refreshStats();
            } else {
                showToast(data.error || 'Failed to update status', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Failed to update status', 'error');
        });
    }
    
    // Bulk Status Update
    function showBulkStatusModal(orderIds = null) {
        const selectedIds = orderIds || Array.from(document.querySelectorAll('.order-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (selectedIds.length === 0) {
            showToast('Please select orders first', 'warning');
            return;
        }
        
        // Show a confirmation modal for bulk status update
        const status = prompt('Enter new status for selected orders (pending, processing, shipped, delivered, cancelled):', 'processing');
        
        if (status && ['pending', 'processing', 'shipped', 'delivered', 'cancelled'].includes(status.toLowerCase())) {
            if (confirm(`Update ${selectedIds.length} order(s) to "${status}"?`)) {
                updateMultipleOrderStatus(selectedIds, status.toLowerCase());
            }
        } else if (status) {
            showToast('Invalid status entered', 'warning');
        }
    }
    
    function updateMultipleOrderStatus(orderIds, status) {
        showLoading();
        
        fetch('/admin/orders/bulk-update-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                order_ids: orderIds,
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                // Update UI for each order
                orderIds.forEach(orderId => {
                    const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                    if (row) {
                        const statusBadge = row.querySelector('.badge-admin');
                        const statusClasses = {
                            'pending': 'warning',
                            'processing': 'info',
                            'shipped': 'primary',
                            'delivered': 'success',
                            'cancelled': 'danger'
                        };
                        
                        // Remove existing status classes
                        statusBadge.className = statusBadge.className.replace(/badge-\w+/, '');
                        // Add new class
                        statusBadge.classList.add(`badge-${statusClasses[status]}`);
                        statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    }
                });
                
                showToast(`Updated ${data.updated} order(s) to "${status}"`, 'success');
                clearSelection();
                refreshStats();
            } else {
                showToast(data.error || 'Failed to update orders', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showToast('Failed to update orders', 'error');
        });
    }
    
    // Other Order Actions
    function markAsPaid(orderId) {
        if (confirm('Mark this order as paid?')) {
            showLoading();
            
            fetch(`/admin/orders/${orderId}/mark-paid`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    // Update payment status badge
                    const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                    const paymentBadge = row.querySelectorAll('.badge-admin')[1];
                    
                    paymentBadge.className = paymentBadge.className.replace(/badge-\w+/, '');
                    paymentBadge.classList.add('badge-success');
                    paymentBadge.textContent = 'Paid';
                    
                    showToast('Order marked as paid', 'success');
                } else {
                    showToast(data.error || 'Failed to mark as paid', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('Failed to mark as paid', 'error');
            });
        }
    }
    
    function cancelOrder(orderId) {
        if (confirm('Cancel this order? This action cannot be undone.')) {
            showLoading();
            
            fetch(`/admin/orders/${orderId}/cancel`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    // Update status badge
                    const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                    const statusBadge = row.querySelector('.badge-admin');
                    
                    statusBadge.className = statusBadge.className.replace(/badge-\w+/, '');
                    statusBadge.classList.add('badge-danger');
                    statusBadge.textContent = 'Cancelled';
                    
                    showToast('Order cancelled', 'success');
                    refreshStats();
                } else {
                    showToast(data.error || 'Failed to cancel order', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('Failed to cancel order', 'error');
            });
        }
    }
    
    function cancelSelectedOrders(orderIds) {
        if (confirm(`Cancel ${orderIds.length} selected order(s)? This action cannot be undone.`)) {
            showLoading();
            
            fetch('/admin/orders/bulk-cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    order_ids: orderIds
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    // Update UI for each order
                    orderIds.forEach(orderId => {
                        const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                        if (row) {
                            const statusBadge = row.querySelector('.badge-admin');
                            statusBadge.className = statusBadge.className.replace(/badge-\w+/, '');
                            statusBadge.classList.add('badge-danger');
                            statusBadge.textContent = 'Cancelled';
                        }
                    });
                    
                    showToast(`Cancelled ${data.cancelled} order(s)`, 'success');
                    clearSelection();
                    refreshStats();
                } else {
                    showToast(data.error || 'Failed to cancel orders', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('Failed to cancel orders', 'error');
            });
        }
    }
    
    // Export Functions
    function exportSelectedOrders(orderIds) {
        const selectedOrders = orderIds.map(id => {
            const row = document.querySelector(`tr[data-order-id="${id}"]`);
            if (row) {
                const cells = row.querySelectorAll('td');
                return {
                    order_number: cells[1].textContent.trim(),
                    customer: cells[2].textContent.trim(),
                    items: cells[3].textContent.trim(),
                    amount: cells[4].textContent.trim(),
                    status: cells[5].textContent.trim(),
                    payment: cells[6].textContent.trim(),
                    date: cells[7].textContent.trim()
                };
            }
        }).filter(order => order);
        
        if (selectedOrders.length === 0) {
            showToast('No orders to export', 'warning');
            return;
        }
        
        exportToCSV(selectedOrders, `orders-${new Date().toISOString().split('T')[0]}.csv`);
    }
    
    // Print Functions
    function printOrders() {
        const printWindow = window.open('', '_blank');
        const tableContent = document.getElementById('ordersTable').outerHTML;
        
        printWindow.document.write(`
            <html>
            <head>
                <title>Orders Report - {{ config.brand_name }}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background: #f8f9fa; font-weight: 600; }
                    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                    .text-center { text-align: center; }
                    h1 { margin-bottom: 20px; }
                    .print-header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <h1>Orders Report - {{ config.brand_name }}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    <p>Total Orders: {{ orders|length if orders else 0 }}</p>
                </div>
                ${tableContent}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
    }
    
    function printSelectedOrders(orderIds) {
        // Similar to printOrders but only selected rows
        const selectedRows = orderIds.map(id => {
            const row = document.querySelector(`tr[data-order-id="${id}"]`);
            return row ? row.outerHTML : '';
        }).join('');
        
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
            <html>
            <head>
                <title>Selected Orders Report - {{ config.brand_name }}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background: #f8f9fa; font-weight: 600; }
                    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                    .text-center { text-align: center; }
                    h1 { margin-bottom: 20px; }
                    .print-header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                </style>
            </head>
            <body>
                <div class="print-header">
                    <h1>Selected Orders Report - {{ config.brand_name }}</h1>
                    <p>Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}</p>
                    <p>Showing ${orderIds.length} selected order(s)</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Order #</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${selectedRows}
                    </tbody>
                </table>
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.print();
    }
    
    // Utility Functions
    function refreshOrders() {
        showLoading();
        setTimeout(() => {
            location.reload();
        }, 500);
    }
    
    function refreshStats() {
        // This would typically fetch updated stats from the server
        // For now, we'll just note that stats should be refreshed
        console.log('Stats should be refreshed');
    }
    
    function createNewOrder() {
        showToast('New order creation feature coming soon!', 'info');
    }
    
    function updateBulkPayment(orderIds) {
        if (confirm(`Mark ${orderIds.length} selected order(s) as paid?`)) {
            showLoading();
            
            fetch('/admin/orders/bulk-mark-paid', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    order_ids: orderIds
                })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    // Update payment status for each order
                    orderIds.forEach(orderId => {
                        const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
                        if (row) {
                            const paymentBadge = row.querySelectorAll('.badge-admin')[1];
                            paymentBadge.className = paymentBadge.className.replace(/badge-\w+/, '');
                            paymentBadge.classList.add('badge-success');
                            paymentBadge.textContent = 'Paid';
                        }
                    });
                    
                    showToast(`Marked ${data.updated} order(s) as paid`, 'success');
                    clearSelection();
                } else {
                    showToast(data.error || 'Failed to update payments', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('Failed to update payments', 'error');
            });
        }
    }
</script>
{% endblock %}
