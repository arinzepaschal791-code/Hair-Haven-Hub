{% extends "admin/base.html" %}

{% block title %}Customers - {{ config.brand_name }} Admin{% endblock %}

{% block page_title %}Customer Management{% endblock %}
{% block page_subtitle %}Manage and view all registered customers{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-admin" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Customers</h6>
                            <h2 class="text-white mb-0">{{ customers|length if customers else 0 }}</h2>
                            <small class="text-white-50">All registered customers</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-admin" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Today's Signups</h6>
                            <h2 class="text-white mb-0">{{ today_customers|default(0) }}</h2>
                            <small class="text-white-50">New customers today</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-admin" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Active This Week</h6>
                            <h2 class="text-white mb-0">{{ active_this_week|default(0) }}</h2>
                            <small class="text-white-50">Customers with orders this week</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card-admin" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-white-50 mb-1">Average Orders</h6>
                            <h2 class="text-white mb-0">{{ avg_orders_per_customer|default(0)|round(1) }}</h2>
                            <small class="text-white-50">Orders per customer</small>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Table -->
    <div class="card-admin">
        <div class="card-header-admin d-flex justify-content-between align-items-center">
            <h5>All Customers</h5>
            <div class="d-flex gap-2">
                <div class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" id="searchInput" class="form-control-admin" placeholder="Search customers...">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchCustomers()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <button class="btn btn-sm btn-primary-admin" onclick="exportCustomers()">
                    <i class="fas fa-download me-1"></i> Export
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-admin table-hover" id="customersTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" class="form-check-input">
                        </th>
                        <th>Customer ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Location</th>
                        <th>Orders</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if customers and customers|length > 0 %}
                        {% for customer in customers %}
                        <tr data-customer-id="{{ customer.id }}">
                            <td>
                                <input type="checkbox" class="customer-checkbox form-check-input" value="{{ customer.id }}">
                            </td>
                            <td>
                                <span class="fw-medium">#CUST{{ "%04d" % customer.id }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-2" 
                                         style="width: 35px; height: 35px; background: #{{ '%06x' % (customer.id * 123456) % 0xffffff }}; 
                                                color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                        {{ customer.first_name[0]|upper if customer.first_name else 'C' }}
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ customer.first_name }} {{ customer.last_name }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;">
                                    <a href="mailto:{{ customer.email }}" class="text-decoration-none">
                                        {{ customer.email }}
                                    </a>
                                </div>
                            </td>
                            <td>
                                {% if customer.phone %}
                                <a href="tel:{{ customer.phone }}" class="text-decoration-none">
                                    {{ customer.phone }}
                                </a>
                                {% else %}
                                <span class="text-muted">Not provided</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if customer.city or customer.state %}
                                <div class="text-truncate" style="max-width: 150px;">
                                    {{ customer.city or '' }}{% if customer.city and customer.state %}, {% endif %}{{ customer.state or '' }}
                                </div>
                                {% else %}
                                <span class="text-muted">Unknown</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if customer.orders %}
                                    {% set order_count = customer.orders|length %}
                                    <span class="badge-admin {% if order_count > 0 %}bg-primary{% else %}bg-secondary{% endif %}">
                                        {{ order_count }} order{% if order_count != 1 %}s{% endif %}
                                    </span>
                                {% else %}
                                    <span class="badge-admin bg-secondary">No orders</span>
                                {% endif %}
                            </td>
                            <td>
                                <div>{{ customer.created_at.strftime('%b %d, %Y') }}</div>
                                <small class="text-muted">{{ customer.created_at.strftime('%I:%M %p') }}</small>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewCustomerDetails({{ customer.id }})" 
                                            data-bs-toggle="tooltip" data-bs-placement="top" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewCustomerOrders({{ customer.id }})"
                                            data-bs-toggle="tooltip" data-bs-placement="top" title="View Orders">
                                        <i class="fas fa-shopping-bag"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="sendEmailToCustomer('{{ customer.email }}')"
                                            data-bs-toggle="tooltip" data-bs-placement="top" title="Send Email">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteCustomer({{ customer.id }})"
                                            data-bs-toggle="tooltip" data-bs-placement="top" title="Delete Customer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                    <h5>No Customers Found</h5>
                                    <p class="text-muted mb-0">No customers have registered yet.</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if customers and customers|length > 0 %}
        <div class="card-footer border-top-0 bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">Showing {{ customers|length }} of {{ customers|length }} customers</small>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Previous</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bulk Actions -->
    <div class="card-admin mt-3" id="bulkActions" style="display: none;">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span id="selectedCount">0</span> customer(s) selected
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;" id="bulkActionSelect">
                        <option value="">Bulk Actions</option>
                        <option value="export">Export Selected</option>
                        <option value="email">Send Email to Selected</option>
                    </select>
                    <button class="btn btn-sm btn-primary-admin" onclick="applyBulkAction()">Apply</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Details Modal -->
<div class="modal fade" id="customerDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerDetailsContent">
                <!-- Customer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Customer Orders Modal -->
<div class="modal fade" id="customerOrdersModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Orders</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerOrdersContent">
                <!-- Customer orders will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Customer Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Delete Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this customer?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. All customer data will be permanently deleted.
                </div>
                <form id="deleteCustomerForm" method="POST" style="display: none;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitDeleteCustomer()">Delete Customer</button>
            </div>
        </div>
    </div>
</div>

<style>
    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }
    
    .empty-state i {
        opacity: 0.5;
    }
    
    .avatar {
        flex-shrink: 0;
    }
    
    #bulkActions {
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Keep track of current customer ID for deletion
    let currentCustomerId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        initEventListeners();
        initTooltips();
    });
    
    function initEventListeners() {
        // Select All checkbox
        const selectAll = document.getElementById('selectAll');
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.customer-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBulkActions();
            });
        }
        
        // Individual checkboxes
        document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });
        
        // Search input
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    searchCustomers();
                }
            });
        }
    }
    
    function initTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    }
    
    // Search Customers
    function searchCustomers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('#customersTable tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }
    
    // Bulk Actions
    function updateBulkActions() {
        const selectedCount = document.querySelectorAll('.customer-checkbox:checked').length;
        const bulkActionsDiv = document.getElementById('bulkActions');
        
        if (selectedCount > 0) {
            document.getElementById('selectedCount').textContent = selectedCount;
            bulkActionsDiv.style.display = 'block';
        } else {
            bulkActionsDiv.style.display = 'none';
        }
    }
    
    function clearSelection() {
        document.querySelectorAll('.customer-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        const selectAll = document.getElementById('selectAll');
        if (selectAll) {
            selectAll.checked = false;
        }
        updateBulkActions();
    }
    
    function applyBulkAction() {
        const action = document.getElementById('bulkActionSelect').value;
        const selectedIds = Array.from(document.querySelectorAll('.customer-checkbox:checked'))
            .map(checkbox => checkbox.value);
        
        if (!action) {
            showAlert('Please select an action', 'warning');
            return;
        }
        
        if (selectedIds.length === 0) {
            showAlert('No customers selected', 'warning');
            return;
        }
        
        switch(action) {
            case 'export':
                exportSelectedCustomers(selectedIds);
                break;
            case 'email':
                sendBulkEmail(selectedIds);
                break;
        }
    }
    
    // Export Functions
    function exportCustomers() {
        const customers = Array.from(document.querySelectorAll('#customersTable tbody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return {
                id: cells[1].textContent.trim(),
                name: cells[2].textContent.trim(),
                email: cells[3].textContent.trim(),
                phone: cells[4].textContent.trim(),
                location: cells[5].textContent.trim(),
                orders: cells[6].textContent.trim(),
                joined: cells[7].textContent.trim()
            };
        });
        
        exportToCSV(customers, 'customers.csv');
    }
    
    function exportSelectedCustomers(ids) {
        const selectedCustomers = ids.map(id => {
            const row = document.querySelector(`tr[data-customer-id="${id}"]`);
            if (row) {
                const cells = row.querySelectorAll('td');
                return {
                    id: cells[1].textContent.trim(),
                    name: cells[2].textContent.trim(),
                    email: cells[3].textContent.trim(),
                    phone: cells[4].textContent.trim(),
                    location: cells[5].textContent.trim(),
                    orders: cells[6].textContent.trim(),
                    joined: cells[7].textContent.trim()
                };
            }
            return null;
        }).filter(customer => customer !== null);
        
        if (selectedCustomers.length === 0) {
            showAlert('No customers to export', 'warning');
            return;
        }
        
        exportToCSV(selectedCustomers, `selected-customers-${new Date().toISOString().split('T')[0]}.csv`);
    }
    
    function exportToCSV(data, filename) {
        if (!data || data.length === 0) {
            showAlert('No data to export', 'warning');
            return;
        }
        
        // Convert data to CSV
        const headers = Object.keys(data[0]);
        const csvRows = [];
        
        // Add header row
        csvRows.push(headers.join(','));
        
        // Add data rows
        for (const row of data) {
            const values = headers.map(header => {
                const escaped = ('' + row[header]).replace(/"/g, '""');
                return `"${escaped}"`;
            });
            csvRows.push(values.join(','));
        }
        
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', filename);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showAlert('Export completed successfully!', 'success');
    }
    
    // View Customer Details
    function viewCustomerDetails(customerId) {
        showLoading();
        
        // In a real application, you would fetch customer details from the server
        // For now, we'll use the data from the table
        const row = document.querySelector(`tr[data-customer-id="${customerId}"]`);
        if (row) {
            const cells = row.querySelectorAll('td');
            
            // Get customer name and first letter for avatar
            const customerName = cells[2].textContent.trim();
            const firstLetter = customerName.charAt(0).toUpperCase();
            
            const content = `
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="avatar mx-auto mb-3" 
                             style="width: 100px; height: 100px; background: #{{ '%06x' % (customerId * 123456) % 0xffffff }}; 
                                    color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                    font-size: 2.5rem; font-weight: bold;">
                            ${firstLetter}
                        </div>
                        <h5>${customerName}</h5>
                        <p class="text-muted mb-0">Customer ID: #CUST${customerId.toString().padStart(4, '0')}</p>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-medium text-muted">Email Address</label>
                                <p class="mb-0">${cells[3].textContent.trim()}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-medium text-muted">Phone Number</label>
                                <p class="mb-0">${cells[4].textContent.trim()}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-medium text-muted">Location</label>
                                <p class="mb-0">${cells[5].textContent.trim()}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-medium text-muted">Total Orders</label>
                                <p class="mb-0">${cells[6].textContent.trim()}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-medium text-muted">Member Since</label>
                                <p class="mb-0">${cells[7].textContent.trim()}</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-medium text-muted">Account Status</label>
                                <p class="mb-0"><span class="badge-admin badge-success">Active</span></p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6>Customer Information</h6>
                            <p class="text-muted">Full customer details and order history would be displayed here. 
                            In a production environment, this would fetch detailed information from the server.</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsContent').innerHTML = content;
            
            const modal = new bootstrap.Modal(document.getElementById('customerDetailsModal'));
            modal.show();
        }
        
        hideLoading();
    }
    
    // View Customer Orders
    function viewCustomerOrders(customerId) {
        showLoading();
        
        // This would normally fetch from the server
        // For now, show a message
        const content = `
            <div class="text-center py-5">
                <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                <h5>Customer Orders</h5>
                <p class="text-muted">Order details would be fetched from the server in a production environment.</p>
                <p class="text-muted mb-0">Customer ID: #CUST${customerId.toString().padStart(4, '0')}</p>
            </div>
            
            <div class="text-center mt-3">
                <a href="{{ url_for('admin_orders') }}" class="btn btn-primary-admin">
                    <i class="fas fa-external-link-alt me-2"></i> View All Orders
                </a>
            </div>
        `;
        
        document.getElementById('customerOrdersContent').innerHTML = content;
        
        const modal = new bootstrap.Modal(document.getElementById('customerOrdersModal'));
        modal.show();
        
        hideLoading();
    }
    
    // Send Email
    function sendEmailToCustomer(email) {
        window.location.href = `mailto:${email}?subject={{ config.brand_name }} - Inquiry`;
    }
    
    function sendBulkEmail(customerIds) {
        showAlert(`Preparing to send email to ${customerIds.length} customers...`, 'info');
        // In production, this would open an email composer or show a modal
    }
    
    // Delete Customer
    function confirmDeleteCustomer(customerId) {
        currentCustomerId = customerId;
        const row = document.querySelector(`tr[data-customer-id="${customerId}"]`);
        if (row) {
            const customerName = row.querySelector('td:nth-child(3)').textContent.trim();
            const modal = new bootstrap.Modal(document.getElementById('deleteCustomerModal'));
            
            // Update the form action
            const form = document.getElementById('deleteCustomerForm');
            form.action = "{{ url_for('admin_delete_customer', id=0) }}".replace('/0', '/' + customerId);
            
            modal.show();
        }
    }
    
    function submitDeleteCustomer() {
        if (currentCustomerId) {
            showLoading();
            
            // Submit the form
            const form = document.getElementById('deleteCustomerForm');
            form.submit();
        }
    }
    
    // Helper Functions
    function showAlert(message, type = 'info') {
        // Remove any existing alert
        const existingAlert = document.querySelector('.customer-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // Create alert
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show customer-alert`;
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            max-width: 400px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        `;
        
        const icon = type === 'success' ? 'fa-check-circle' :
                    type === 'danger' ? 'fa-exclamation-circle' :
                    type === 'warning' ? 'fa-exclamation-triangle' :
                    'fa-info-circle';
        
        alertDiv.innerHTML = `
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }
        }, 5000);
    }
    
    function showLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.add('active');
        }
    }
    
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.classList.remove('active');
        }
    }
</script>
{% endblock %}
