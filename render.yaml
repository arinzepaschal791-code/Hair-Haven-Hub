services:
  - type: web
    name: norahairline-ecommerce
    env: python
    region: oregon
    plan: free
    branch: main
    buildCommand: |
      echo "üöÄ Starting build process..."
      echo "‚úÖ Step 1: Upgrading pip"
      pip install --upgrade pip
      
      echo "‚úÖ Step 2: Installing critical dependencies first"
      pip install setuptools==59.6.0 wheel==0.37.1 six==1.16.0
      
      echo "‚úÖ Step 3: Installing remaining requirements"
      pip install -r requirements.txt
      
      echo "‚úÖ Step 4: Verifying installation"
      python -c "
      import sys
      print(f'üêç Python version: {sys.version}')
      
      # Verify pkg_resources
      try:
          import pkg_resources
          print('‚úÖ pkg_resources loaded successfully')
      except ImportError as e:
          print(f'‚ùå pkg_resources error: {e}')
          sys.exit(1)
      
      # Verify six.moves for gunicorn
      try:
          import six.moves
          print('‚úÖ six.moves loaded successfully')
      except ImportError as e:
          print(f'‚ùå six.moves error: {e}')
          sys.exit(1)
      
      # Verify SQLAlchemy
      try:
          import sqlalchemy
          print(f'‚úÖ SQLAlchemy {sqlalchemy.__version__} loaded')
      except ImportError as e:
          print(f'‚ùå SQLAlchemy error: {e}')
          sys.exit(1)
      
      # Verify Flask
      try:
          import flask
          print(f'‚úÖ Flask {flask.__version__} loaded')
      except ImportError as e:
          print(f'‚ùå Flask error: {e}')
          sys.exit(1)
      
      print('üéâ All dependencies verified successfully!')
      "
      
      echo "‚úÖ Build completed successfully!"
      
    startCommand: |
      echo "üöÄ Starting application..."
      echo "üêç Python version: $(python --version)"
      echo "‚úÖ Running gunicorn with wsgi entry point"
      gunicorn wsgi:app --bind 0.0.0.0:$PORT --workers 2 --timeout 120 --access-logfile - --error-logfile -
      
    healthCheckPath: /health
    autoDeploy: true
    
    envVars:
      # ========== APPLICATION CONFIGURATION ==========
      - key: SECRET_KEY
        generateValue: true
      - key: FLASK_APP
        value: main.py
      - key: FLASK_ENV
        value: production
      - key: FLASK_DEBUG
        value: false
      - key: DEBUG
        value: false
      
      # ========== ADMIN CREDENTIALS ==========
      - key: ADMIN_EMAIL
        value: admin@norahairline.com
      - key: ADMIN_PASSWORD
        value: admin123
      - key: ADMIN_USERNAME
        value: admin
      
      # ========== SECURITY CONFIGURATION ==========
      - key: WTF_CSRF_ENABLED
        value: true
      - key: WTF_CSRF_SECRET_KEY
        generateValue: true
      - key: SESSION_COOKIE_SECURE
        value: true
      - key: SESSION_COOKIE_HTTPONLY
        value: true
      - key: SESSION_COOKIE_SAMESITE
        value: Lax
      - key: PERMANENT_SESSION_LIFETIME
        value: 86400
      - key: REMEMBER_COOKIE_DURATION
        value: 86400
      
      # ========== DATABASE CONFIGURATION ==========
      - key: SQLALCHEMY_TRACK_MODIFICATIONS
        value: false
      - key: SQLALCHEMY_ENGINE_OPTIONS
        value: '{"pool_recycle": 300, "pool_pre_ping": true, "pool_size": 10, "max_overflow": 20}'
      
      # ========== FILE UPLOAD CONFIGURATION ==========
      - key: MAX_CONTENT_LENGTH
        value: 16777216
      - key: UPLOAD_FOLDER
        value: static/uploads
      - key: ALLOWED_EXTENSIONS
        value: png,jpg,jpeg,gif,webp
      
      # ========== BUSINESS CONFIGURATION ==========
      - key: BUSINESS_NAME
        value: NORA HAIR LINE
      - key: BUSINESS_EMAIL
        value: info@norahairline.com
      - key: BUSINESS_PHONE
        value: 08038707795
      - key: CURRENCY
        value: NGN
      - key: CURRENCY_SYMBOL
        value: ‚Ç¶
      - key: FREE_DELIVERY_THRESHOLD
        value: 150000
      - key: LAGOS_MAINLAND_DELIVERY
        value: 3000
      - key: LAGOS_ISLAND_DELIVERY
        value: 3500
      - key: OTHER_STATES_DELIVERY
        value: 5000
      
      # ========== PAYMENT CONFIGURATION ==========
      - key: PAYMENT_ACCOUNT
        value: 2059311531
      - key: PAYMENT_BANK
        value: UBA
      - key: PAYMENT_NAME
        value: CHUKWUNEKE CHIAMAKA
      
      # ========== PERFORMANCE CONFIGURATION ==========
      - key: WEB_CONCURRENCY
        value: 2
      - key: PYTHONUNBUFFERED
        value: true
      - key: PYTHONHASHSEED
        value: random
      - key: PYTHONPATH
        value: /opt/render/project/src

    # ========== DISK STORAGE FOR UPLOADS ==========
    disk:
      name: uploads
      mountPath: /opt/render/project/src/static/uploads
      sizeGB: 1

    # ========== DATABASE ==========
    databases:
      - name: norahairline-db
        databaseName: norahairline
        user: norahairline_user
        plan: free
        postgresMajorVersion: 15
        ipAllowList: [] # Allow only from internal network
